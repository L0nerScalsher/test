# Profile Microservice Help

## Содержание

- [Описание модуля](#описание-модуля)
- [Функциональные возможности](#функциональные-возможности)
- [Архитектура](#архитектура)
    - [Сущности (Entities)](#сущности-entities)
    - [DTO (Data Transfer Objects)](#dto-data-transfer-objects)
    - [Репозитории (Repositories)](#репозитории-repositories)
    - [Сервисный слой (Services)](#сервисный-слой-services)
    - [Мапперы (Mappers)](#мапперы-mappers)
    - [Контроллер (Controller)](#контроллер-controller)
    - [AOP-слой (Audit Logging)](#aop-слой-audit-logging)
    - [Конфигурация](#конфигурация)
- [Основные API-сценарии](#основные-api-сценарии)
    - [Создание профиля](#1-создание-профиля)
    - [Обновление профиля](#2-обновление-профиля)
    - [Удаление профиля](#3-удаление-профиля)
    - [Получение профиля](#4-получение-профиля)
- [Технологический стек](#технологический-стек)
- [Обработка ошибок (Exception Handling)](#обработка-ошибок-exception-handling)
- [Безопасность](#безопасность)
- [Логирование и мониторинг](#логирование-и-мониторинг)
- [Развертывание](#развертывание)
- [Дополнительные требования](#дополнительные-требования)

## Описание модуля

Profile Microservice отвечает за управление пользовательскими профилями, их регистрацией и паспортными данными. Также он ведет историю изменений через систему аудита.

## Функциональные возможности

- REST API с CRUD-операциями.
- Логирование изменений в таблицу аудита (только `create` и `update`).
- Интеграция с PostgreSQL.
- JWT-аутентификация.
- Автоматическая генерация документации (Swagger/OpenAPI).
- Использование **констант или Enum**, где это целесообразно (например, для ролей, типов операций).

## Архитектура

### Сущности (Entities)

- `Profile` – основная модель профиля пользователя.
- `Passport` – паспортные данные пользователя.
- `Registration` – регистрационные данные пользователя.
- `ActualRegistration` – фактический адрес проживания.
- `AccountDetails` – связь профиля с учетной записью.
- `Audit` – запись аудита.

### DTO (Data Transfer Objects)

- `ProfileDto` – передача данных профиля через API.
- `PassportDto` – передача паспортных данных.
- `RegistrationDto` – передача регистрационных данных.
- `AuditDto` – передача информации об изменениях.

### Репозитории (Repositories)

- `ProfileRepository` – управление профилями.
- `PassportRepository` – управление паспортными данными.
- `RegistrationRepository` – управление регистрацией.
- `ActualRegistrationRepository` – управление фактическим местом жительства.
- `AuditRepository` – управление аудитом.

### Сервисный слой (Services)

- `ProfileService` – интерфейс CRUD-операций для профиля.

- `ProfileServiceImpl` – реализация бизнес-логики.

- `PassportService` – интерфейс CRUD-операций для паспортных данных.

- `PassportServiceImpl` – реализация бизнес-логики.

- `RegistrationService` – интерфейс CRUD-операций для регистрационных данных.

- `RegistrationServiceImpl` – реализация бизнес-логики.

- `ActualRegistrationService` – интерфейс CRUD-операций для фактического места жительства.

- `ActualRegistrationServiceImpl` – реализация бизнес-логики.

- `AccountDetailsService` – интерфейс CRUD-операций для связи профилей с учетными записями.

- `AccountDetailsServiceImpl` – реализация бизнес-логики.

- `AuditService` – интерфейс для работы с аудитом.

- `AuditServiceImpl` – реализация логирования изменений.

### Мапперы (Mappers)

- `ProfileMapper` – преобразует сущности профиля в DTO и обратно. Использует **MapStruct** и работает под управлением Spring&#x20;
- `AuditMapper` – преобразует сущности аудита в DTO и обратно.

### Контроллеры (Controllers)

- `ProfileController` – REST API для управления профилями.
- `PassportController` – REST API для управления паспортными данными.
- `RegistrationController` – REST API для управления регистрацией.
- `ActualRegistrationController` – REST API для управления фактическим местом жительства.
- `AccountDetailsController` – REST API для управления связью профилей с учетными записями.

### AOP-слой (Audit Logging)

- `AuditAspect` – аспект, перехватывающий вызовы методов `create` и `update` в `ProfileServiceImpl`.
- Автоматически заполняет таблицу `Audit` при изменении данных профиля.
- Записывает, кто и когда внес изменения.
- **Для соблюдения принципа единственной ответственности (SRP), бизнес-логика выносится в сервисный слой.**
- AOP-слой отвечает только за перехват вызовов и регистрацию изменений, а сам процесс аудита выполняется в `AuditService`.

### Конфигурация

- `SwaggerConfig` – настройка Swagger.

## Основные API-сценарии

### 1. Создание профиля

- **POST** `/profiles`
- Создает запись в `Profile` и логирует в `Audit`.

### 2. Обновление профиля

- **PUT** `/profiles/{id}`
- Обновляет данные в `Profile`, фиксирует изменения в `Audit`.

### 3. Удаление профиля

- **DELETE** `/profiles/{id}`
- Удаляет запись (без логирования в аудит).

### 4. Получение профиля

- **GET** `/profiles` – список всех профилей.
- **GET** `/profiles/{id}` – данные конкретного профиля.

## Технологический стек

- Java 17
- Spring Boot 3.x
- Spring Data JPA
- PostgreSQL
- Lombok
- MapStruct
- Spring Security (JWT)
- Spring AOP
- Swagger/OpenAPI
- Logback (Slf4j)

## Обработка ошибок (Exception Handling)

- `GlobalExceptionHandler` – глобальный обработчик исключений для API.
- Обрабатывает `EntityNotFoundException`, `ValidationException` и другие стандартные ошибки.
- Возвращает структурированные ответы с кодами ошибок.

## Безопасность

- API защищено JWT-аутентификацией.
- Логируются действия пользователей.

## Логирование и мониторинг

- Используется `Slf4j` для логирования операций.
- Детализированные сообщения об ошибках.
- Логирование успешных и неуспешных операций.

## Развертывание

- Контейнеризация через Docker.
- Kubernetes (Helm Charts).
- Конфигурация через `application.yml`.

## Дополнительные требования

- Код соответствует принципам SOLID.
- Использование **констант или Enum** для предсказуемости данных.
- Предусмотрены unit- и интеграционные тесты.
- Готовность к CI/CD (GitLab CI/GitHub Actions).

---

Этот документ поможет быстро развернуть и использовать микросервис.

